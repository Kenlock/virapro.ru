<template>
  <div id="central_view">
    <PriceFilter/>
    <el-row v-if="products && !Object.keys(products).length && $store.getters.LOADING" type="flex" justify="center">
      <i class="el-icon-loading" style="margin-top: 20px;"></i>
    </el-row>
    <el-row v-if="products && !Object.keys(products).length && !$store.getters.LOADING" type="flex" justify="center">
      <div id="no_products">Товары отсутствуют</div>
    </el-row>
    <el-row>
      <el-col
        :span="24" v-for="p in products" :key="p.productId"
        itemscope itemtype="http://schema.org/ItemList">
        <ProductCard
          v-if="showProduct(p)" :id="p.productId"
          itemprop="itemListElement" itemtype="http://schema.org/Product"/>
      </el-col>
    </el-row>
    <el-row id="load_more">
      <div>
        <el-button
          v-if="$store.getters.lastVisible"
          type="text"
          @click="loadMore"
          :disabled="$store.getters.LOADING">
          Загрузить больше
        </el-button>
      </div>
    </el-row>
  </div>
</template>
<script>
  import PriceFilter from "@/components/catalog/PriceFilter"
  import ProductCard from "@/components/catalog/ProductCard"

  export default {
    name: 'CatalogProductsView',
    components: {PriceFilter, ProductCard},
    data() {
      return {
        hoverOnCard: false
      }
    },
    methods: {
      async loadMore() {
        this.$store.dispatch('USER_EVENT', 'Загрузить больше')
        await this.$store.dispatch('fetchProducts')
      },
      showProduct(p) {
        return (!this.$store.getters.productDynamicFilters ||
          (this.$store.getters.productDynamicFilters &&
            this.$store.getters.dynamicFilteredProductsIds.indexOf(p.productId) !== -1)) &&
          (p.price > this.$store.getters.productCommonFilters.minPrice &&
            p.price < this.$store.getters.productCommonFilters.maxPrice)
      },
      sortByProp(arr, prop) {
        let x, y
        return arr.sort(function (a, b) {
          x = a[prop] ? a[prop].trim() : ''
          y = b[prop] ? b[prop].trim() : ''
          return x === y ? 0 : +(x > y) || -1
        })
      }
    },
    computed: {
      products() {
        let products = this.$store.getters.products ? Object.values(this.$store.getters.products) : []
        return products.length ? this.sortByProp(products, 'title') : []
      },
      dictionaries() {
        return this.$store.getters.dictionaries
      },
      user() {
        return this.$store.getters.user
      }
    }
  }
</script>
<style scoped lang="scss">

  #central_view {
    /*min-width: 600px;*/
    flex: 1;
  }

  #load_more {
    display: flex;
    justify-content: center;
    margin-top: 10px;
  }

  #no_products {
    margin-top: 10px;
    color: $color-info-dark;
  }

  @media only screen and (max-width: $xs-screen) {
    flex: 0 0 90vw !important;
  }
</style>
